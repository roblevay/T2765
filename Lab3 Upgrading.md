
# ğŸ§ª SQL Server â€“ Copying and Restoring Databases

## ğŸ¯ Objective

Learn two different methods to copy a database from one SQL Server instance (`North`) to another (`North\A`):

- Doing a **manual backup/restore**, handling logins, fixing orphaned users, and updating compatibility level.
- Using the **Copy Database Wizard (Detach and Attach)**  


---

## ğŸ§© Prerequisites

- You need sysadmin rights on both `North` and `North\A`.
- SQL Server Agent must be **running** on both servers.
- The database to be copied must be **offline-able** (for the wizard method).
- The database `AdventureWorks` should already exist on `North`.

---



## ğŸ§· Method 1 â€“ Manual Backup and Restore  

If it not exists, create the folder C:\DbFiles

### ğŸ” Step 1 â€“ Create Login and User on the source server

Create a SQL Server login on the default instance:  

â€¢ Name: Liza  
â€¢ Password: myS3cret  

Create a user in the Adventureworks database for above login. The user should also be named Liza.

---

### ğŸ’¾ Step 2 â€“ Create and restore a backup

Create a backup of the Adventureworks database on the default instance. Use whatever backup file name and path you want (for instance C:\DbFiles\ Adventureworks.bak).  

Restore this backup on the A instance. Make sure that the database physical file names are different from the default instanceâ€™s names (since you are on the same machine).  

Update statistics on the restored database. This isnâ€™t really related to doing an upgrade or copy/move of a database since the statistics comes with the backup and there are no changes between statistics format between versions. But almost everybody â€œout thereâ€ believes that this is necessary so feel free to do that if you have the time. Use the procedure sp_updatestats to do this.

---

### ğŸ§© Step 3 â€“ Manage an orphaned user

Your SQL user Liza in the Adventureworks database on the A instance is orphaned.  

First, you want to list your orphaned users. Use sp_change_users_login to do this.  

And then you want to connect that user to a login. You have several options to do this  

1. Create a login for Liza and then use ALTER USER Liza WITH LOGIN = Liza (you can also use sp_change_users_login, if you prefer).  
2. Script out the login from the source instance using sp_help_revlogin (search and install from the internet) and then create the login on the A instance based on the command generated by sp_help_revlogin.  
3. Use some other of the many scripts available out there.

---

### âš™ï¸ Step 4 â€“ Raise the Compatibility Level

Check current level:

Imagine that the developers/vendors now say that they support the new versionsâ€™s compatibility level.  

Also, imagine that you have been running your application with Query Store enabled for a couple of weeks so you have a history of your SQL queries, their execution plans and run-time statistics.  

You now feel that you want to raise the compatibility level for the database. Do that.

---

### âœ… Final Checks

* Confirm login `Liza` works on `North\A`.
* Validate that compatibility level is updated.
* Verify restored data in `AdventureWorks`.

---

## Method 1 Answer suggestions

### ğŸ” Step 1 â€“ Manual Backup and Restore 

On `North`:

```sql
CREATE LOGIN Liza WITH PASSWORD = 'myS3cret';
GO
USE AdventureWorks;
CREATE USER Liza;
```

---

### ğŸ’¾ Step 2 â€“ Create and restore a backup

1. On `North`, back up the database:

```sql
BACKUP DATABASE AdventureWorks
TO DISK = 'C:\DbFiles\AdventureWorks.bak';
```

2. On `North\A`, restore the database with different physical file names:

```sql
RESTORE DATABASE AdventureWorks
FROM DISK = 'C:\DbFiles\AdventureWorks.bak'
WITH MOVE 'AdventureWorks2017' TO 'C:\DbFiles\AdventureWorks2017.mdf',
     MOVE 'AdventureWorks2017_Log' TO 'C:\DbFiles\AdventureWorks2017_Log.ldf';
```

3. Optionally update statistics:

```sql
USE AdventureWorks;
EXEC sp_updatestats;
```

---

### ğŸ§© Step 3 â€“ Manage an orphaned user

On `North\A`:

```sql
USE AdventureWorks;
EXEC sp_change_users_login 'Report';
```

Create login for Liza:
```sql
CREATE LOGIN Liza WITH PASSWORD = 'myS3cret'
```

Then fix the orphaned user:

```sql
ALTER USER Liza WITH LOGIN = Liza;
```



---

### âš™ï¸ Step 4 â€“ Raise the Compatibility Level

Check current level:

```sql
SELECT compatibility_level
FROM sys.databases
WHERE name = 'AdventureWorks';
```

Raise it (example for SQL Server 2019):

```sql
ALTER DATABASE AdventureWorks
SET COMPATIBILITY_LEVEL = 150;
```

## ğŸ§· Method 2 â€“ Copy Database Wizard (Detach and Attach)

### ğŸ” Step 1 â€“ Set SQL Server Agent Credentials on `North\A`

1. Open **SQL Server Configuration Manager** on `North\A`.
2. Go to **SQL Server Services**.
3. Right-click **SQL Server Agent (NORTH\A)** > **Properties**.
4. In the **Log On** tab:
   - Select **This account**
   - Enter:
     - **User**: `Student`
     - **Password**: `myS3cret`
5. Click **OK** and restart the SQL Server Agent service.

---

### ğŸ› ï¸ Step 2 â€“ Create a Sample Database on `North`

Run on the `North` instance:

```sql
CREATE DATABASE MoveDb;
GO

USE MoveDb;
CREATE TABLE TestData (
    ID INT PRIMARY KEY,
    Name NVARCHAR(100)
);
INSERT INTO TestData VALUES (1, 'Gamma'), (2, 'Delta');
````

---

### ğŸ§™ Step 3 â€“ Use the Copy Database Wizard (Detach and Attach)

1. In SSMS, connect to `North`.
2. Right-click the server > **Tasks** > **Copy Database**.
3. Click **Next** on the welcome screen.
4. Select `North` as the Source Server and click **Next**
5. Select `North\A` as the destination server and click **Next**
6. Choose **Use Detach and Attach method** â†’ click **Next**.
7. Select to copy the database: `MoveDb` â†’ click **Next**.
8. Set destination file paths if needed â†’ click **Next**.
9. In Configure the Package â†’ click **Next**.
10. Schedule the package to run immediately and click **Next**
11. Click **Finish** The database will be copied

---

### âœ… Step 4 â€“ Confirm the Migration

On `North\A`, verify:

```sql
SELECT * FROM MoveDb.dbo.TestData;
```

---

### ğŸ“ Notes (Detach and Attach)

* This method **takes the source database offline** during the transfer.
* It is **fast** for large databases but requires **downtime**.
* Make sure file paths are valid and accessible between the two servers.

---

### ğŸ“ Notes (Manual Method)

* Use **different file names** to avoid collisions on same machine.
* `sp_updatestats` is often used after restores, even if not technically required.
* Raising compatibility level can affect performance and query behavior.

---
